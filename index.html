<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Steam Guard Dashboard</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --dark-bg: #1a1a2e;
      --card-bg: rgba(255, 255, 255, 0.95);
      --sidebar-bg: rgba(26, 26, 46, 0.95);
    }
    
    body {
      background: var(--primary-gradient);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .sidebar {
      background: linear-gradient(rgba(26, 26, 46, 0.8), rgba(26, 26, 46, 0.8)), url('backgroud2.jpg');
      background-size: cover;
      background-position: center;
      backdrop-filter: blur(10px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .main-content {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      min-height: 100vh;
    }
    
    .card {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border: none;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 20px;
      transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .btn-modern {
      border-radius: 25px;
      padding: 10px 25px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-modern:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .nav-link {
      border-radius: 10px;
      margin: 5px 0;
      transition: all 0.3s ease;
    }
    
    .nav-link:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(5px);
    }
    
    .table {
      border-radius: 15px;
      overflow: hidden;
    }
    
    .table thead th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      font-weight: 600;
    }
    
    .status-badge {
      border-radius: 20px;
      padding: 5px 15px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .search-box {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 25px;
      border: none;
      padding: 12px 20px;
    }
    
    .search-box:focus {
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
    }
  </style>
</head>
<body>
  <div class="container-fluid p-0">
    <div class="row g-0">
      <!-- Modern Sidebar -->
      <div class="col-lg-2 col-md-3 sidebar d-none d-md-block" style="min-height: 100vh;">
        <div class="p-4 position-relative" style="min-height: 100vh;">
          <!-- Logo Section -->
          <div class="text-center mb-5">
            <div class="bg-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
              <i class="bi bi-display-fill text-primary fs-3"></i>
            </div>
            <h5 class="text-white fw-bold mb-0">Steam Guard</h5>
            <small class="text-white-50">Dashboard v0.1</small>
          </div>
          
          <!-- Navigation -->
          <nav class="nav flex-column">
            <a class="nav-link active text-white d-flex align-items-center" href="index.html">
              <i class="bi bi-speedometer2 me-3"></i>
              <span>Dashboard</span>
            </a>
            <a class="nav-link text-white-50 d-flex align-items-center" href="manage-leagues.html">
              <i class="bi bi-trophy me-3"></i>
              <span>Manage Leagues</span>
            </a>
            <a class="nav-link text-white-50 d-flex align-items-center" href="manage-matches.html">
              <i class="bi bi-calendar-event me-3"></i>
              <span>Manage Matches</span>
            </a>
          </nav>
          
          <hr class="text-white-50 my-4">
          
          <!-- User Section -->
          <div class="text-center position-absolute bottom-0 start-0 end-0 p-4">
            <div class="bg-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 40px; height: 40px;">
              <i class="bi bi-person-fill text-primary"></i>
            </div>
            <div class="text-white-50 small" id="userDisplay">Admin User</div>
            <a href="#" class="nav-link text-white-50 small logout">
              <i class="bi bi-box-arrow-right me-1"></i>Logout
            </a>
          </div>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="col-lg-10 col-md-9 main-content">
        <div class="p-4">


          <!-- Stats Cards -->
          <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-3">
              <div class="card stat-card h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="card-title text-white-50 mb-1">Website</h6>
                      <h3 class="mb-0 text-white fw-bold" id="websiteCount">0</h3>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                      <i class="bi bi-window-desktop text-primary fs-4"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-3">
              <div class="card stat-card h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="card-title text-white-50 mb-1">Social Media</h6>
                      <h3 class="mb-0 text-white fw-bold" id="socialMediaCount">0</h3>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                      <i class="bi bi-facebook text-primary fs-4"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-3">
              <div class="card stat-card h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="card-title text-white-50 mb-1">Online</h6>
                      <h3 class="mb-0 text-white fw-bold" id="onlineCount">0</h3>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                      <i class="bi bi-wifi text-primary fs-4"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-3">
              <div class="card stat-card h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="card-title text-white-50 mb-1">Takedown</h6>
                      <h3 class="mb-0 text-white fw-bold" id="takedownCount">0</h3>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                      <i class="bi bi-shield-x text-primary fs-4"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Search and Filters -->
          <div class="card mb-4">
                          <div class="card-body">
                <div class="row g-3 align-items-end">
                  <div class="col-lg-4">
                    <label class="form-label fw-semibold">Search Streams</label>
                    <div class="input-group">
                      <span class="input-group-text bg-transparent border-0">
                        <i class="bi bi-search text-muted"></i>
                      </span>
                      <input type="text" class="form-control search-box" placeholder="Search by title, league, or match...">
                    </div>
                  </div>
                  <div class="col-lg-2">
                    <label class="form-label fw-semibold">Match</label>
                    <select class="form-select">
                      <option selected>All Matches</option>
                      <!-- Options will be loaded dynamically from table data -->
                    </select>
                  </div>
                  <div class="col-lg-2">
                    <label class="form-label fw-semibold">League</label>
                    <select class="form-select">
                      <option selected>All Leagues</option>
                      <!-- Options will be loaded dynamically from table data -->
                    </select>
                  </div>
                  <div class="col-lg-2">
                    <label class="form-label fw-semibold">Date</label>
                    <select class="form-select">
                      <option selected>All Dates</option>
                      <!-- Options will be loaded dynamically from table data -->
                    </select>
                  </div>
                  <div class="col-lg-2">
                    <div class="d-flex gap-2">
                      <button class="btn btn-primary btn-modern flex-fill" onclick="applyFilters()">
                        <i class="bi bi-funnel me-2"></i>Filter
                      </button>
                      <button class="btn btn-outline-secondary btn-modern" onclick="clearFilters()" title="Clear all filters">
                        <i class="bi bi-x-circle"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
          </div>

          <!-- Streams Table -->
          <div class="card">
            <div class="card-header bg-transparent border-0">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0 fw-bold">
                  <i class="bi bi-collection-play me-2"></i>Piracy Streams
                </h5>
                <div class="d-flex gap-2">
                  <button class="btn btn-light btn-modern" data-bs-toggle="modal" data-bs-target="#newUrlModal">
                    <i class="bi bi-plus-circle me-2"></i>New Url
                  </button>
                  <button class="btn btn-light btn-modern text-dark" onclick="exportToCSV()">
                    <i class="bi bi-download me-2"></i>Export
                  </button>
                </div>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead>
                    <tr>
                      <th class="fw-semibold">No.</th>
                      <th class="fw-semibold">URL</th>
                      <th class="fw-semibold">Type</th>
                      <th class="fw-semibold">Matches Name</th>
                      <th class="fw-semibold">League Name</th>
                      <th class="fw-semibold">Created At</th>
                      <th class="fw-semibold">Status</th>
                      <th class="fw-semibold">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Data will be loaded from API -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- New URL Modal -->
  <div class="modal fade" id="newUrlModal" tabindex="-1" aria-labelledby="newUrlModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="newUrlModalLabel">
            <i class="bi bi-plus-circle me-2"></i>Add New URL
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="newUrlForm">
            <div class="row g-3">
              <!-- URL field -->
              <div class="col-12">
                <label for="urlAddress" class="form-label fw-semibold">URL</label>
                <input type="url" class="form-control" id="urlAddress" name="urlAddress" placeholder="https://example.com" required>
              </div>
              
              <!-- Type dropdown -->
              <div class="col-md-6">
                <label for="urlType" class="form-label fw-semibold">Type</label>
                <select class="form-select" id="urlType" name="urlType" required>
                  <option value="">Select Type</option>
                  <option value="Website">Website</option>
                  <option value="Social Media">Social Media</option>
                </select>
              </div>
              
              <!-- League dropdown -->
              <div class="col-md-6">
                <label for="urlLeague" class="form-label fw-semibold">League</label>
                <select class="form-select" id="urlLeague" name="urlLeague" required onchange="loadMatchesForLeague()">
                  <option value="">Select League</option>
                  <!-- Options will be loaded from API -->
                </select>
              </div>
              
              <!-- Matches dropdown -->
              <div class="col-md-6">
                <label for="urlMatches" class="form-label fw-semibold">Matches</label>
                <select class="form-select" id="urlMatches" name="urlMatches" required>
                  <option value="">Select Match</option>
                  <!-- Options will be loaded from API -->
                </select>
              </div>
              
              <!-- Status dropdown -->
              <div class="col-md-6">
                <label for="urlStatus" class="form-label fw-semibold">Status</label>
                <select class="form-select" id="urlStatus" name="urlStatus" required>
                  <option value="">Select Status</option>
                  <option value="Active">Active</option>
                  <option value="Takedown">Takedown</option>
                </select>
              </div>
              
              <!-- Multiple Image upload -->
              <div class="col-12">
                <label class="form-label fw-semibold">Attach Images</label>
                <div class="input-group mb-2">
                  <input type="file" class="form-control" id="urlImage" name="urlImage" accept="image/*" onchange="addImage(this)" multiple>
                  <button class="btn btn-outline-secondary" type="button" onclick="clearAllImages()">
                    <i class="bi bi-x-circle me-1"></i>Clear All
                  </button>
                </div>
                <div id="imagePreviewContainer" class="mt-2">
                  <!-- Images will be added here dynamically -->
                </div>
                <div class="form-text">You can select multiple images. Supported formats: JPG, PNG, GIF, WEBP (max 5MB each)</div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-2"></i>Cancel
          </button>
          <button type="button" class="btn btn-primary" onclick="addNewUrl()">
            <i class="bi bi-plus-circle me-2"></i>Add URL
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- View Stream Details Modal -->
  <div class="modal fade" id="viewStreamModal" tabindex="-1" aria-labelledby="viewStreamModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="viewStreamModalLabel">
            <i class="bi bi-eye me-2"></i>Stream Details
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold">No.</label>
              <p class="form-control-plaintext" id="viewId">-</p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Type</label>
              <p class="form-control-plaintext" id="viewType">-</p>
            </div>
            <div class="col-12">
              <label class="form-label fw-bold">URL</label>
              <p class="form-control-plaintext" id="viewUrl">-</p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">League Name</label>
              <p class="form-control-plaintext" id="viewLeague">-</p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Matches Name</label>
              <p class="form-control-plaintext" id="viewMatches">-</p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Date & Time</label>
              <p class="form-control-plaintext" id="viewDateTime">-</p>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Status</label>
              <p class="form-control-plaintext" id="viewStatus">-</p>
            </div>
            <div class="col-12">
              <label class="form-label fw-bold">Images</label>
              <div id="viewImagesContainer" class="text-center">
                <div class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
                  <div class="text-muted">
                    <i class="bi bi-image fs-1 d-block mb-2"></i>
                    <span>Loading images...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-2"></i>Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Stream Details Modal -->
  <div class="modal fade" id="editStreamModal" tabindex="-1" aria-labelledby="editStreamModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="editStreamModalLabel">
            <i class="bi bi-pencil me-2"></i>Edit Stream Details
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editStreamForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label fw-bold">No.</label>
                <p class="form-control-plaintext" id="editId">-</p>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold">Type</label>
                <select class="form-select" id="editType" name="editType" required>
                  <option value="Website">Website</option>
                  <option value="Social Media">Social Media</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label fw-bold">URL</label>
                <input type="url" class="form-control" id="editUrl" name="editUrl" placeholder="https://example.com" required>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold">League Name</label>
                <select class="form-select" id="editLeague" name="editLeague" required onchange="loadMatchesForEditLeague()">
                  <option value="">Select League</option>
                  <!-- Options will be loaded dynamically -->
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold">Matches Name</label>
                <select class="form-select" id="editMatches" name="editMatches" required>
                  <option value="">Select Match</option>
                  <!-- Options will be loaded dynamically -->
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold">Date & Time</label>
                <p class="form-control-plaintext" id="editDateTime">-</p>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold">Status</label>
                <select class="form-select" id="editStatus" name="editStatus" required>
                  <option value="Active">Active</option>
                  <option value="Pending">Pending</option>
                  <option value="Inactive">Inactive</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label fw-bold">Current Images</label>
                <div id="editImagesContainer" class="text-center">
                  <div class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
                    <div class="text-muted">
                      <i class="bi bi-image fs-1 d-block mb-2"></i>
                      <span>Loading images...</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-12">
                <label class="form-label fw-bold">Add New Images</label>
                <div class="input-group mb-2">
                  <input type="file" class="form-control" id="editNewImages" name="editNewImages" accept="image/*" onchange="addEditImages(this)" multiple>
                  <button class="btn btn-outline-secondary" type="button" onclick="clearAllEditImages()">
                    <i class="bi bi-x-circle me-1"></i>Clear All
                  </button>
                </div>
                <div id="editNewImagesContainer" class="mt-2">
                  <!-- New images will be added here dynamically -->
                </div>
                <div class="form-text">You can select multiple images. Supported formats: JPG, PNG, GIF, WEBP (max 5MB each)</div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-2"></i>Cancel
          </button>
          <button type="button" class="btn btn-primary" onclick="updateStreamDetails()">
            <i class="bi bi-check-circle me-2"></i>Update
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Auth Utility -->
  <script src="auth.js"></script>
  
  <script>
    // Global variable to store original data
    let originalSubmissions = [];
    
    // --- Auth check ---
    if (!validateAuth()) {
      // validateAuth() will handle the redirect
      // This prevents the rest of the script from executing
      throw new Error('Authentication failed');
    }

    // Logout handler
    const logoutBtn = document.querySelector('.logout');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', function(e) {
        e.preventDefault();
        logout();
      });
    }

    // Update counts when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Load URL submissions from API
      loadUrlSubmissions();
      
      // Set up periodic token validation (check every 5 minutes)
      setInterval(() => {
        if (!validateAuth()) {
          console.log('Token validation failed during periodic check');
        }
      }, 5 * 60 * 1000); // 5 minutes
      
      // Display token information for debugging (remove in production)
      displayTokenInfo();
      
      // Debug token for troubleshooting
      debugToken();
    });

    // Add event listener for New URL modal
    const newUrlModal = document.getElementById('newUrlModal');
    if (newUrlModal) {
      newUrlModal.addEventListener('show.bs.modal', function() {
        // Load leagues when opening New URL modal
        loadLeaguesForNewUrl();
      });
    }

    // Function to load leagues for New URL modal
    async function loadLeaguesForNewUrl() {
      try {
        // Check authentication before proceeding
        if (!validateAuth()) {
          return;
        }
        
        // Show loading state
        showLeagueDropdownLoading();
        
        // Fetch leagues from API using authenticated request
        const response = await makeAuthenticatedRequest('https://web-anti-backend-8286388439.asia-southeast1.run.app/leagues', {
          method: 'GET',
          headers: {
            'accept': 'application/json'
          }
        });
        
        if (response.ok) {
          const leagues = await response.json();
          console.log('Leagues loaded for New URL modal:', leagues);
          populateLeagueDropdown(leagues);
        } else {
          console.error('Error loading leagues:', response.status);
          showLeagueDropdownError();
        }
      } catch (error) {
        console.error('Network error loading leagues:', error);
        showLeagueDropdownError();
      }
    }

    // Function to populate league dropdown
    function populateLeagueDropdown(leagues) {
      // Filter only active leagues
      const activeLeagues = leagues.filter(league => league.status === 'Active');
      
      // Get dropdown element
      const leagueDropdown = document.getElementById('urlLeague');
      const matchesDropdown = document.getElementById('urlMatches');
      
      if (leagueDropdown) {
        // Create the first "Select League" option
        const firstOption = '<option value="">Select League</option>';
        const optionsHTML = activeLeagues.map(league => 
          `<option value="${league.league_id}">${league.league_name} (${league.country})</option>`
        ).join('');
        
        leagueDropdown.innerHTML = firstOption + optionsHTML;
        console.log('League dropdown populated with', activeLeagues.length, 'active leagues');
        
        // Reset matches dropdown when leagues are loaded
        if (matchesDropdown) {
          matchesDropdown.innerHTML = '<option value="">Select Match</option>';
        }
      }
    }

    // Function to show loading state in league dropdown
    function showLeagueDropdownLoading() {
      const leagueDropdown = document.getElementById('urlLeague');
      const matchesDropdown = document.getElementById('urlMatches');
      
      if (leagueDropdown) {
        leagueDropdown.innerHTML = '<option value="">Loading leagues...</option>';
      }
      
      // Also reset matches dropdown
      if (matchesDropdown) {
        matchesDropdown.innerHTML = '<option value="">Select Match</option>';
      }
    }

    // Function to show error state in league dropdown
    function showLeagueDropdownError() {
      const leagueDropdown = document.getElementById('urlLeague');
      const matchesDropdown = document.getElementById('urlMatches');
      
      if (leagueDropdown) {
        leagueDropdown.innerHTML = '<option value="">Error loading leagues</option>';
        console.error('Failed to load leagues');
      }
      
      // Also reset matches dropdown
      if (matchesDropdown) {
        matchesDropdown.innerHTML = '<option value="">Select Match</option>';
      }
    }

    // Function to load matches for selected league
    async function loadMatchesForLeague() {
      const leagueId = document.getElementById('urlLeague').value;
      const matchesDropdown = document.getElementById('urlMatches');
      
      // Reset matches dropdown
      matchesDropdown.innerHTML = '<option value="">Select Match</option>';
      
      if (!leagueId) {
        console.log('No league selected, clearing matches dropdown');
        return;
      }
      
      console.log('Loading matches for league ID:', leagueId);
      
      try {
        // Check authentication before proceeding
        if (!validateAuth()) {
          return;
        }
        
        // Show loading state
        matchesDropdown.innerHTML = '<option value="">Loading matches...</option>';
        
        // Fetch matches from API using authenticated request
        const response = await makeAuthenticatedRequest('https://web-anti-backend-8286388439.asia-southeast1.run.app/matches', {
          method: 'GET',
          headers: {
            'accept': 'application/json'
          }
        });
        
        if (response.ok) {
          const matches = await response.json();
          console.log('All matches loaded:', matches);
          
          // Filter matches by selected league
          const leagueMatches = matches.filter(match => {
            console.log(`Comparing match.league_id (${match.league_id}) with selected leagueId (${leagueId})`);
            return match.league_id === leagueId;
          });
          
          console.log('Filtered matches for league:', leagueMatches);
          populateMatchesDropdown(leagueMatches);
        } else {
          console.error('Error loading matches:', response.status);
          showMatchesDropdownError();
        }
      } catch (error) {
        console.error('Network error loading matches:', error);
        showMatchesDropdownError();
      }
    }

    // Function to populate matches dropdown
    function populateMatchesDropdown(matches) {
      const matchesDropdown = document.getElementById('urlMatches');
      
      if (matchesDropdown) {
        if (matches.length === 0) {
          matchesDropdown.innerHTML = '<option value="">No matches found for this league</option>';
          console.log('No matches found for the selected league');
          return;
        }
        
        // Create the first "Select Match" option
        const firstOption = '<option value="">Select Match</option>';
        
        const optionsHTML = matches.map(match => {
          // Format date for display
          const matchDate = new Date(match.match_date);
          const formattedDate = matchDate.toLocaleDateString('en-GB', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
          });
          
          return `<option value="${match.match_id}">${match.home_team} VS ${match.away_team} (${formattedDate})</option>`;
        }).join('');
        
        matchesDropdown.innerHTML = firstOption + optionsHTML;
        console.log('Matches dropdown populated with', matches.length, 'matches');
      }
    }

    // Function to show error state in matches dropdown
    function showMatchesDropdownError() {
      const matchesDropdown = document.getElementById('urlMatches');
      if (matchesDropdown) {
        matchesDropdown.innerHTML = '<option value="">Error loading matches</option>';
        console.error('Failed to load matches for the selected league');
      }
    }

    // Function to load URL submissions from API
    async function loadUrlSubmissions() {
      try {
        // Check authentication before proceeding
        if (!validateAuth()) {
          return;
        }
        
        // Fetch URL submissions from API using authenticated request
        const response = await makeAuthenticatedRequest('https://web-anti-backend-8286388439.asia-southeast1.run.app/url_submission', {
          method: 'GET',
          headers: {
            'accept': 'application/json'
          }
        });
        
        if (response.ok) {
          const submissions = await response.json();
          console.log('URL submissions loaded:', submissions);
          
          // Store original data for filtering
          originalSubmissions = submissions;
          
          displayUrlSubmissions(submissions);
        } else {
          console.error('Error loading URL submissions:', response.status);
          // Show fallback data if API fails
          displayUrlSubmissions([]);
        }
      } catch (error) {
        console.error('Network error loading URL submissions:', error);
        // Show fallback data if network error
        displayUrlSubmissions([]);
      }
    }

    // Function to display URL submissions in table
    function displayUrlSubmissions(submissions) {
      const tbody = document.querySelector('table tbody');
      if (!tbody) return;
      
      if (submissions.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center text-muted py-4">
              <i class="bi bi-inbox fs-1 d-block mb-2"></i>
              No URL submissions found
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = submissions.map((submission, index) => {
        // Format date for display
        const createdDate = new Date(submission.created_at);
        const formattedDate = createdDate.toLocaleString('en-GB', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        }).replace(',', '');
        
        // Determine badge color based on type
        let typeBadgeClass = 'bg-primary'; // Social Media (blue)
        if (submission.type === 'Website') {
          typeBadgeClass = 'bg-danger'; // Website (red)
        }
        
        // Determine status badge color
        let statusBadgeClass = 'bg-secondary';
        if (submission.status === 'Active') statusBadgeClass = 'bg-success';
        else if (submission.status === 'Pending') statusBadgeClass = 'bg-warning';
        else if (submission.status === 'Inactive') statusBadgeClass = 'bg-danger';
        
        return `
          <tr data-submission-id="${submission.submission_id || ''}" data-match-id="${submission.match_id || ''}">
            <td><span class="badge bg-light text-dark">${index + 1}</span></td>
            <td>
              <a href="${submission.url}" class="text-decoration-none" target="_blank" title="${submission.url}">
                ${submission.url.length > 30 ? submission.url.substring(0, 30) + '...' : submission.url}
              </a>
            </td>
            <td><span class="badge ${typeBadgeClass}" style="min-width: 100px;">${submission.type || 'N/A'}</span></td>
            <td>
              <div class="fw-semibold">${submission.matches_name || 'N/A'}</div>
            </td>
            <td>${submission.league_name || 'N/A'}</td>
            <td>${formattedDate}</td>
            <td><span class="badge ${statusBadgeClass} text-white" style="min-width: 100px;">${submission.status || 'N/A'}</span></td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="viewStreamDetails(this)">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-outline-secondary" onclick="editStreamDetails(this)">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="deleteUrlSubmission('${submission.submission_id || ''}', '${(submission.url || '').replace(/'/g, "\\'")}')">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      // Update counts after displaying data
      updateTypeCounts();
      
      // Update match filter dropdown with unique matches from table
      updateMatchFilterDropdown(submissions);
      
      // Update league filter dropdown with unique leagues from table
      updateLeagueFilterDropdown(submissions);
      
      // Update date filter dropdown with unique dates from table
      updateDateFilterDropdown(submissions);
    }
    


    // Function to check URL validity
    function checkUrl() {
      const urlInput = document.getElementById('urlAddress');
      const url = urlInput.value.trim();
      
      if (!url) {
        alert('Please enter a URL to check');
        return;
      }
      
      // Validate URL format
      try {
        new URL(url);
        
        // Show success message
        const checkButton = urlInput.nextElementSibling;
        const originalText = checkButton.innerHTML;
        checkButton.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i>Valid';
        checkButton.className = 'btn btn-success';
        
        // Reset button after 2 seconds
        setTimeout(() => {
          checkButton.innerHTML = originalText;
          checkButton.className = 'btn btn-outline-primary';
        }, 2000);
        
      } catch (error) {
        // Show error message
        const checkButton = urlInput.nextElementSibling;
        const originalText = checkButton.innerHTML;
        checkButton.innerHTML = '<i class="bi bi-x-circle me-1"></i>Invalid';
        checkButton.className = 'btn btn-danger';
        
        // Reset button after 2 seconds
        setTimeout(() => {
          checkButton.innerHTML = originalText;
          checkButton.className = 'btn btn-outline-primary';
        }, 2000);
        
        alert('Please enter a valid URL format (e.g., https://example.com)');
      }
    }

    // Global variable to store selected images
    let selectedImages = [];

    // Function to add images to the preview
    function addImage(input) {
      if (input.files) {
        const files = Array.from(input.files);
        
        files.forEach(file => {
          // Validate file type
          const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
          if (!allowedTypes.includes(file.type)) {
            alert(`File ${file.name} is not a valid image type. Please select JPG, PNG, GIF, or WEBP files.`);
            return;
          }
          
          // Validate file size (max 5MB)
          const maxSize = 5 * 1024 * 1024; // 5MB
          if (file.size > maxSize) {
            alert(`File ${file.name} is too large. Maximum size is 5MB.`);
            return;
          }
          
          // Add file to selected images
          selectedImages.push(file);
        });
        
        // Update preview
        updateImagePreview();
        
        // Clear input for next selection
        input.value = '';
      }
    }

    // Function to update image preview
    function updateImagePreview() {
      const container = document.getElementById('imagePreviewContainer');
      
      if (selectedImages.length === 0) {
        container.innerHTML = '<div class="text-muted text-center py-3"><i class="bi bi-image fs-4 d-block mb-2"></i>No images selected</div>';
        return;
      }
      
      const imagesHTML = selectedImages.map((file, index) => {
        const reader = new FileReader();
        let imageSrc = '';
        
        reader.onload = function(e) {
          imageSrc = e.target.result;
        };
        reader.readAsDataURL(file);
        
        return `
          <div class="col-md-4 mb-3">
            <div class="card">
              <div class="card-body p-2">
                <img src="${URL.createObjectURL(file)}" class="img-fluid rounded" style="max-height: 120px; width: 100%; object-fit: cover;">
                <div class="small text-muted mt-1">${file.name}</div>
                <div class="small text-muted">${(file.size / 1024).toFixed(1)} KB</div>
                <button type="button" class="btn btn-sm btn-outline-danger mt-1" onclick="removeImage(${index})">
                  <i class="bi bi-trash"></i> Remove
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = `
        <div class="row">
          ${imagesHTML}
        </div>
      `;
    }

    // Function to remove a specific image
    function removeImage(index) {
      selectedImages.splice(index, 1);
      updateImagePreview();
    }

    // Function to clear all selected images
    function clearAllImages() {
      selectedImages = [];
      updateImagePreview();
      document.getElementById('urlImage').value = '';
    }

    // Function to view stream details
    async function viewStreamDetails(button) {
      const row = button.closest('tr');
      const cells = row.querySelectorAll('td');
      
      // Extract data from table row
      const no = cells[0].querySelector('.badge').textContent.trim();
      const url = cells[1].querySelector('a').textContent.trim();
      const type = cells[2].querySelector('.badge').textContent.trim();
      const matchesName = cells[3].querySelector('.fw-semibold').textContent.trim();
      const leagueName = cells[4].textContent.trim();
      const dateTime = cells[5].textContent.trim();
      const status = cells[6].querySelector('.badge').textContent.trim();
      
      // Get submission ID from the row (we need to store this in the table data)
      const submissionId = row.getAttribute('data-submission-id');
      
      // Populate modal with data
      document.getElementById('viewId').textContent = no;
      document.getElementById('viewUrl').textContent = url;
      document.getElementById('viewType').textContent = type;
      document.getElementById('viewMatches').textContent = matchesName;
      document.getElementById('viewLeague').textContent = leagueName;
      document.getElementById('viewDateTime').textContent = dateTime;
      document.getElementById('viewStatus').textContent = status;
      
      // Show modal first
      const modal = new bootstrap.Modal(document.getElementById('viewStreamModal'));
      modal.show();
      
      // Load images from API if we have submission ID
      if (submissionId) {
        await loadStreamImages(submissionId);
      } else {
        // No submission ID, show default image
        const viewImage = document.getElementById('viewImage');
        viewImage.src = 'demo.webp';
        viewImage.alt = `Stream Image - ${matchesName}`;
      }
    }

    async function addNewUrl() {
      const form = document.getElementById('newUrlForm');
      const formData = new FormData(form);
      
      // Get form values
      const urlAddress = formData.get('urlAddress');
      const urlType = formData.get('urlType');
      const urlLeague = formData.get('urlLeague');
      const urlMatches = formData.get('urlMatches');
      const urlStatus = formData.get('urlStatus');
      
      // Get selected images
      const imageFiles = selectedImages;
      
      // Validate form
      if (!urlAddress || !urlType || !urlLeague || !urlMatches || !urlStatus) {
        alert('Please fill in all required fields');
        return;
      }
      
      // Validate URL format
      try {
        new URL(urlAddress);
      } catch (error) {
        alert('Please enter a valid URL');
        return;
      }
      
      // Get Add URL button for loading state
      const addBtn = document.querySelector('#newUrlModal .btn.btn-primary');
      const originalBtnHTML = addBtn.innerHTML;
      
      // Set loading state
      addBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Adding...';
      addBtn.disabled = true;
      
      try {
        // Check authentication before proceeding
        if (!validateAuth()) {
          return;
        }
        
        // Prepare payload for API call according to the specification
        const payload = {
          url: urlAddress,
          type: urlType,
          league_id: urlLeague,
          match_id: urlMatches,
          status: urlStatus,
          image_file_name: imageFiles.length > 0 ? imageFiles.map(f => f.name).join(', ') : null
        };
        
        console.log('Sending URL submission payload:', payload);
        
        // Test OPTIONS request first (preflight) for url_submission
        console.log('Testing OPTIONS request (preflight) for url_submission...');
        try {
          const optionsResponse = await fetch('https://web-anti-backend-8286388439.asia-southeast1.run.app/url_submission', {
            method: 'OPTIONS',
            headers: {
              'Access-Control-Request-Method': 'POST',
              'Access-Control-Request-Headers': 'Content-Type, Authorization, accept'
            }
          });
          console.log('url_submission OPTIONS response status:', optionsResponse.status);
          console.log('url_submission OPTIONS response headers:', optionsResponse.headers);
        } catch (optionsError) {
          console.log('url_submission OPTIONS request failed:', optionsError);
        }
        
        // Test OPTIONS request for matches API (for comparison)
        console.log('Testing OPTIONS request (preflight) for matches...');
        try {
          const matchesOptionsResponse = await fetch('https://web-anti-backend-8286388439.asia-southeast1.run.app/matches', {
            method: 'OPTIONS',
            headers: {
              'Access-Control-Request-Method': 'POST',
              'Access-Control-Request-Headers': 'Content-Type, Authorization, accept'
            }
          });
          console.log('matches OPTIONS response status:', matchesOptionsResponse.status);
          console.log('matches OPTIONS response headers:', matchesOptionsResponse.headers);
        } catch (matchesOptionsError) {
          console.log('matches OPTIONS request failed:', matchesOptionsError);
        }
        
        // Make POST API call using authenticated request
        const response = await makeAuthenticatedRequest('https://web-anti-backend-8286388439.asia-southeast1.run.app/url_submission', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'accept': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        

        
        if (response.ok) {
          const result = await response.json();
          console.log('URL submission added successfully:', result);
          
          // Get submission_id from the response
          const submissionId = result.submission_id;
          
          // If there are image files, upload them
          if (imageFiles.length > 0 && submissionId) {
            console.log(`Uploading ${imageFiles.length} images for submission ID:`, submissionId);
            
            try {
              // Get token for image upload
              const token = getValidAccessToken();
              if (!token) {
                alert('Authentication token not found for image upload. Please login again.');
                return;
              }
              
              // Upload each image
              let uploadedCount = 0;
              let failedCount = 0;
              
              for (const imageFile of imageFiles) {
                try {
                  // Create FormData for image upload
                  const imageFormData = new FormData();
                  imageFormData.append('file', imageFile);
                  
                  // Upload image to the submission
                  const imageResponse = await fetch(`https://web-anti-backend-8286388439.asia-southeast1.run.app/upload/${submissionId}`, {
                    method: 'POST',
                    headers: {
                      'Authorization': `Bearer ${token}`,
                      'accept': 'application/json'
                    },
                    body: imageFormData
                  });
                  
                  if (imageResponse.ok) {
                    const imageResult = await imageResponse.json();
                    console.log(`Image ${imageFile.name} uploaded successfully:`, imageResult);
                    uploadedCount++;
                  } else {
                    const imageErrorData = await imageResponse.json().catch(() => ({}));
                    console.error(`Error uploading image ${imageFile.name}:`, imageErrorData);
                    failedCount++;
                  }
                } catch (imageError) {
                  console.error(`Network error uploading image ${imageFile.name}:`, imageError);
                  failedCount++;
                }
              }
              
              // Show result message
              if (uploadedCount > 0 && failedCount === 0) {
                alert(`URL submission and ${uploadedCount} image(s) uploaded successfully!`);
              } else if (uploadedCount > 0 && failedCount > 0) {
                alert(`URL submission created successfully! ${uploadedCount} image(s) uploaded, ${failedCount} failed.`);
              } else if (uploadedCount === 0 && failedCount > 0) {
                alert('URL submission created successfully, but all image uploads failed.');
              }
            } catch (imageError) {
              console.error('Network error uploading images:', imageError);
              alert('URL submission created successfully, but image uploads failed due to network error.');
            }
          } else {
            // No image files, just show success for URL submission
            alert('URL submission added successfully!');
          }
          
          // Close modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('newUrlModal'));
          modal.hide();
          
          // Reset form
          form.reset();
          clearAllImages(); // Clear all selected images
          
          // Reload URL submissions data
          loadUrlSubmissions();
          
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error('Error adding URL submission:', errorData);
          alert('Error adding URL submission: ' + (errorData.detail || 'Unknown error'));
        }
        
      } catch (error) {
        console.error('Network error adding URL submission:', error);
        
        // Check if it's a CORS error
        if (error.message && error.message.includes('CORS')) {
          alert('CORS Error: The server is not allowing cross-origin requests. Please contact the administrator.');
        } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
          alert('Network Error: Unable to connect to the server. Please check your internet connection.');
        } else {
          alert('Network error. Please try again. Error: ' + error.message);
        }
      } finally {
        // Restore button state
        addBtn.innerHTML = originalBtnHTML;
        addBtn.disabled = false;
      }
    }

    // Function to delete URL submission
    async function deleteUrlSubmission(submissionId, url) {
      if (!submissionId) {
        alert('Submission ID not found');
        return;
      }
      
      // Confirm deletion
      if (!confirm(`Are you sure you want to delete this URL submission?\n\nURL: ${url}`)) {
        return;
      }
      
      // Show loading state
      const deleteBtn = event.target.closest('.btn-outline-danger');
      const originalHTML = deleteBtn.innerHTML;
      deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
      deleteBtn.disabled = true;
      
      try {
        // Check authentication before proceeding
        if (!validateAuth()) {
          return;
        }
        
        console.log('Deleting URL submission:', submissionId);
        
        // Make DELETE API call using authenticated request
        const response = await makeAuthenticatedRequest(`https://web-anti-backend-8286388439.asia-southeast1.run.app/url_submission/${submissionId}`, {
          method: 'DELETE',
          headers: {
            'accept': 'application/json'
          }
        });
        
        if (response.ok) {
          console.log('URL submission deleted successfully');
          alert('URL submission deleted successfully!');
          
          // Reload URL submissions data
          loadUrlSubmissions();
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error('Error deleting URL submission:', errorData);
          alert('Error deleting URL submission: ' + (errorData.detail || 'Unknown error'));
        }
        
      } catch (error) {
        console.error('Network error deleting URL submission:', error);
        alert('Network error. Please try again.');
      } finally {
        // Restore button state
        deleteBtn.innerHTML = originalHTML;
        deleteBtn.disabled = false;
      }
    }

    // Function to update match filter dropdown with unique matches
    function updateMatchFilterDropdown(submissions) {
      // Get unique matches from submissions
      const uniqueMatches = [...new Set(submissions.map(submission => submission.matches_name).filter(name => name && name !== 'N/A'))];
      
      // Get match filter dropdown
      const matchFilterDropdown = document.querySelector('.card-body .col-lg-2:nth-child(2) select');
      
      if (matchFilterDropdown) {
        // Keep the first "All Matches" option
        const firstOption = '<option selected>All Matches</option>';
        
        // Create options for unique matches
        const optionsHTML = uniqueMatches.map(match => 
          `<option value="${match}">${match}</option>`
        ).join('');
        
        matchFilterDropdown.innerHTML = firstOption + optionsHTML;
        console.log('Match filter dropdown updated with', uniqueMatches.length, 'unique matches');
      }
    }

    // Function to update league filter dropdown with unique leagues
    function updateLeagueFilterDropdown(submissions) {
      // Get unique leagues from submissions
      const uniqueLeagues = [...new Set(submissions.map(submission => submission.league_name).filter(name => name && name !== 'N/A'))];
      
      // Get league filter dropdown
      const leagueFilterDropdown = document.querySelector('.card-body .col-lg-2:nth-child(3) select');
      
      if (leagueFilterDropdown) {
        // Keep the first "All Leagues" option
        const firstOption = '<option selected>All Leagues</option>';
        
        // Create options for unique leagues
        const optionsHTML = uniqueLeagues.map(league => 
          `<option value="${league}">${league}</option>`
        ).join('');
        
        leagueFilterDropdown.innerHTML = firstOption + optionsHTML;
        console.log('League filter dropdown updated with', uniqueLeagues.length, 'unique leagues');
      }
    }

    // Function to update date filter dropdown with unique dates
    function updateDateFilterDropdown(submissions) {
      // Get unique dates from submissions
      const uniqueDates = [...new Set(submissions.map(submission => {
        const createdDate = new Date(submission.created_at);
        return createdDate.toLocaleDateString('en-GB', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
      }).filter(date => date && date !== 'N/A'))];
      
      // Get date filter dropdown
      const dateFilterDropdown = document.querySelector('.card-body .col-lg-2:nth-child(4) select');
      
      if (dateFilterDropdown) {
        // Keep the first "All Dates" option
        const firstOption = '<option selected>All Dates</option>';
        
        // Create options for unique dates
        const optionsHTML = uniqueDates.sort().map(date => 
          `<option value="${date}">${date}</option>`
        ).join('');
        
        dateFilterDropdown.innerHTML = firstOption + optionsHTML;
        console.log('Date filter dropdown updated with', uniqueDates.length, 'unique dates');
      }
    }

    // Function to apply filters
    function applyFilters() {
      // Get filter values
      const searchText = document.querySelector('.search-box').value.toLowerCase().trim();
      const selectedMatch = document.querySelector('.card-body .col-lg-2:nth-child(2) select').value;
      const selectedLeague = document.querySelector('.card-body .col-lg-2:nth-child(3) select').value;
      const selectedDate = document.querySelector('.card-body .col-lg-2:nth-child(4) select').value;
      
      console.log('Applying filters:', {
        searchText,
        selectedMatch,
        selectedLeague,
        selectedDate
      });
      
      // Filter submissions based on criteria
      const filteredSubmissions = originalSubmissions.filter(submission => {
        // Search text filter (partial match)
        const searchMatch = !searchText || 
          submission.url.toLowerCase().includes(searchText) ||
          (submission.matches_name && submission.matches_name.toLowerCase().includes(searchText)) ||
          (submission.league_name && submission.league_name.toLowerCase().includes(searchText)) ||
          (submission.type && submission.type.toLowerCase().includes(searchText));
        
        // Match filter
        const matchFilter = selectedMatch === 'All Matches' || 
          (submission.matches_name && submission.matches_name === selectedMatch);
        
        // League filter
        const leagueFilter = selectedLeague === 'All Leagues' || 
          (submission.league_name && submission.league_name === selectedLeague);
        
        // Date filter
        const submissionDate = new Date(submission.created_at);
        const formattedSubmissionDate = submissionDate.toLocaleDateString('en-GB', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
        const dateFilter = selectedDate === 'All Dates' || 
          formattedSubmissionDate === selectedDate;
        
        return searchMatch && matchFilter && leagueFilter && dateFilter;
      });
      
      console.log('Filtered results:', filteredSubmissions.length, 'out of', originalSubmissions.length);
      
      // Display filtered results
      displayUrlSubmissions(filteredSubmissions);
    }

    // Function to clear all filters
    function clearFilters() {
      // Clear search box
      document.querySelector('.search-box').value = '';
      
      // Reset dropdowns to "All" options
      document.querySelector('.card-body .col-lg-2:nth-child(2) select').selectedIndex = 0;
      document.querySelector('.card-body .col-lg-2:nth-child(3) select').selectedIndex = 0;
      document.querySelector('.card-body .col-lg-2:nth-child(4) select').selectedIndex = 0;
      
      console.log('Filters cleared, showing all data');
      
      // Display original data
      displayUrlSubmissions(originalSubmissions);
    }

    // Function to count types and status in table
    function updateTypeCounts() {
      const table = document.querySelector('table');
      if (!table) return;

      let websiteCount = 0;
      let socialMediaCount = 0;
      let onlineCount = 0;
      let takedownCount = 0;

      // Get all table rows
      const tableRows = table.querySelectorAll('tbody tr');
      
      tableRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 7) { // Make sure we have enough cells for both type and status
          // Count Type (3rd column, index 2)
          const typeCell = cells[2];
          if (typeCell.querySelector('.badge')) {
            const typeText = typeCell.querySelector('.badge').textContent.trim();
            
            if (typeText === 'Website') {
              websiteCount++;
            } else if (typeText === 'Social Media') {
              socialMediaCount++;
            }
          }
          
          // Count Status (7th column, index 6)
          const statusCell = cells[6];
          if (statusCell.querySelector('.badge')) {
            const statusText = statusCell.querySelector('.badge').textContent.trim();
            
            if (statusText === 'Inactive') {
              takedownCount++;
            } else {
              // Count all other statuses (Active, Pending, etc.) as Online
              onlineCount++;
            }
          }
        }
      });

      // Update the display
      document.getElementById('websiteCount').textContent = websiteCount;
      document.getElementById('socialMediaCount').textContent = socialMediaCount;
      document.getElementById('onlineCount').textContent = onlineCount;
      document.getElementById('takedownCount').textContent = takedownCount;
    }

    // Function to export table data to CSV
    function exportToCSV() {
      // Check authentication before proceeding
      if (!validateAuth()) {
        return;
      }
      
      const table = document.querySelector('table');
      if (!table) {
        alert('No table found to export');
        return;
      }

      // Get table headers
      const headers = [];
      const headerCells = table.querySelectorAll('thead th');
      headerCells.forEach(cell => {
        headers.push(cell.textContent.trim());
      });

      // Get table rows data
      const rows = [];
      const tableRows = table.querySelectorAll('tbody tr');
      
      tableRows.forEach(row => {
        const rowData = [];
        const cells = row.querySelectorAll('td');
        
        cells.forEach((cell, index) => {
          let cellText = '';
          
          // Handle different types of content in cells
          if (cell.querySelector('a')) {
            // If cell contains a link, get the link text
            cellText = cell.querySelector('a').textContent.trim();
          } else if (cell.querySelector('.badge')) {
            // If cell contains a badge, get the badge text
            cellText = cell.querySelector('.badge').textContent.trim();
          } else if (cell.querySelector('.fw-semibold')) {
            // If cell contains text with fw-semibold class
            cellText = cell.querySelector('.fw-semibold').textContent.trim();
          } else {
            // Regular text content
            cellText = cell.textContent.trim();
          }
          
          // Skip action buttons column (last column)
          if (index < cells.length - 1) {
            rowData.push(cellText);
          }
        });
        
        rows.push(rowData);
      });

      // Create CSV content
      let csvContent = '';
      
      // Add headers
      csvContent += headers.slice(0, -1).map(header => `"${header}"`).join(',') + '\n';
      
      // Add data rows
      rows.forEach(row => {
        csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
      });

      // Create and download file
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `streams_data_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } else {
        // Fallback for older browsers
        alert('Your browser does not support automatic download. Please copy the data manually.');
        console.log('CSV Data:', csvContent);
      }
    }

    // Function to load stream images from API
    async function loadStreamImages(submissionId) {
      try {
        // Check authentication before proceeding
        if (!validateAuth()) {
          return;
        }
        
        console.log('Loading images for submission ID:', submissionId);
        
        // Fetch images from API using authenticated request
        const response = await makeAuthenticatedRequest(`https://web-anti-backend-8286388439.asia-southeast1.run.app/upload/list/${submissionId}`, {
          method: 'GET',
          headers: {
            'accept': 'application/json'
          }
        });
        
        if (response.ok) {
          const images = await response.json();
          console.log('Images loaded:', images);
          displayStreamImages(images);
        } else {
          console.error('Error loading images:', response.status);
          displayNoImages();
        }
      } catch (error) {
        console.error('Network error loading images:', error);
        displayNoImages();
      }
    }

    // Function to display stream images
    function displayStreamImages(images) {
      const container = document.getElementById('viewImagesContainer');
      
      if (!images || images.length === 0) {
        displayNoImages();
        return;
      }
      
      // Create image gallery
      const imagesHTML = images.map((image, index) => {
        // Convert gs:// URL to a displayable URL if needed
        const imageUrl = image.file_url.startsWith('gs://') 
          ? `https://storage.googleapis.com/${image.file_url.replace('gs://', '')}`
          : image.file_url;
        
        return `
          <div class="mb-3">
            <img src="${imageUrl}" class="img-fluid rounded" style="max-width: 400px; max-height: 300px;" 
                 alt="Stream Image ${index + 1}" onerror="this.src='demo.webp'">
            <div class="small text-muted mt-1">
              ${image.file_name} (${(image.file_size / 1024).toFixed(1)} KB)
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = `
        <div class="row">
          ${images.map((image, index) => `
            <div class="col-md-6 mb-3">
              <div class="text-center">
                <img src="${image.file_url.startsWith('gs://') 
                  ? `https://storage.googleapis.com/${image.file_url.replace('gs://', '')}` 
                  : image.file_url}" 
                     class="img-fluid rounded" style="max-width: 100%; max-height: 200px;" 
                     alt="Stream Image ${index + 1}" 
                     onerror="this.src='demo.webp'">
                <div class="small text-muted mt-1">
                  ${image.file_name} (${(image.file_size / 1024).toFixed(1)} KB)
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Function to display no images message
    function displayNoImages() {
      const container = document.getElementById('viewImagesContainer');
      container.innerHTML = `
        <div class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
          <div class="text-muted">
            <i class="bi bi-image fs-1 d-block mb-2"></i>
            <span>No images attached</span>
          </div>
        </div>
      `;
    }

    // Global variable to store selected edit images
    let selectedEditImages = [];
    let currentEditSubmissionId = null;

    // Function to edit stream details
    async function editStreamDetails(button) {
      const row = button.closest('tr');
      const cells = row.querySelectorAll('td');
      
      // Extract data from table row
      const no = cells[0].querySelector('.badge').textContent.trim();
      const url = cells[1].querySelector('a').textContent.trim();
      const type = cells[2].querySelector('.badge').textContent.trim();
      const matchesName = cells[3].querySelector('.fw-semibold').textContent.trim();
      const leagueName = cells[4].textContent.trim();
      const dateTime = cells[5].textContent.trim();
      const status = cells[6].querySelector('.badge').textContent.trim();
      
      // Get submission ID and match ID from the row
      const submissionId = row.getAttribute('data-submission-id');
      const matchId = row.getAttribute('data-match-id');
      currentEditSubmissionId = submissionId;
      
      console.log('Extracted data from table:', {
        no,
        url,
        type,
        matchesName,
        leagueName,
        dateTime,
        status,
        submissionId,
        matchId
      });
      
      // Populate edit modal with basic data
      document.getElementById('editId').textContent = no;
      document.getElementById('editUrl').value = url;
      document.getElementById('editType').value = type;
      document.getElementById('editDateTime').textContent = dateTime;
      document.getElementById('editStatus').value = status;
      
      // Show modal first
      const modal = new bootstrap.Modal(document.getElementById('editStreamModal'));
      modal.show();
      
      // Load match details from API if we have match ID
      if (matchId) {
        await loadMatchDetailsForEdit(matchId);
      } else {
        // Fallback: load leagues and try to set manually
        await loadLeaguesForEdit();
        setTimeout(async () => {
          await setEditLeagueAndMatch(leagueName, matchesName);
        }, 500);
             }
      
      // Load current images
      if (submissionId) {
        await loadEditImages(submissionId);
      }
      
      // Clear any previously selected new images
      selectedEditImages = [];
      updateEditNewImagesPreview();
    }

    // Function to load leagues for edit modal
    async function loadLeaguesForEdit() {
      try {
        if (!validateAuth()) {
          return;
        }
        
        const response = await makeAuthenticatedRequest('https://web-anti-backend-8286388439.asia-southeast1.run.app/leagues', {
          method: 'GET',
          headers: {
            'accept': 'application/json'
          }
        });
        
        if (response.ok) {
          const leagues = await response.json();
          const activeLeagues = leagues.filter(league => league.status === 'Active');
          
          const editLeagueDropdown = document.getElementById('editLeague');
          if (editLeagueDropdown) {
            const firstOption = '<option value="">Select League</option>';
            const optionsHTML = activeLeagues.map(league => 
              `<option value="${league.league_id}">${league.league_name} (${league.country})</option>`
            ).join('');
            
            editLeagueDropdown.innerHTML = firstOption + optionsHTML;
          }
        }
      } catch (error) {
        console.error('Error loading leagues for edit:', error);
      }
    }

    // Function to set league and match in edit modal
    async function setEditLeagueAndMatch(leagueName, matchesName) {
      const editLeagueDropdown = document.getElementById('editLeague');
      const editMatchesDropdown = document.getElementById('editMatches');
      
      // Find and select the correct league
      if (editLeagueDropdown) {
        for (let option of editLeagueDropdown.options) {
          if (option.text.includes(leagueName)) {
            editLeagueDropdown.value = option.value;
            break;
          }
        }
      }
      
      // Load matches for the selected league and then set the match
      if (editLeagueDropdown.value) {
        await loadMatchesForEditLeague();
        
        // Now set the correct match after matches are loaded
        setTimeout(() => {
          setEditMatch(matchesName);
        }, 200);
      }
    }

    // Function to set the correct match in edit modal
    function setEditMatch(matchesName) {
      const editMatchesDropdown = document.getElementById('editMatches');
      
      if (editMatchesDropdown) {
        console.log('Setting match for:', matchesName);
        console.log('Available options:', Array.from(editMatchesDropdown.options).map(opt => opt.text));
        
        for (let option of editMatchesDropdown.options) {
          console.log('Checking option:', option.text, 'against:', matchesName);
          if (option.text.includes(matchesName)) {
            editMatchesDropdown.value = option.value;
            console.log('Match set to:', option.value, 'for:', matchesName);
            break;
          }
        }
        
        // If no match found, log it
        if (!editMatchesDropdown.value) {
          console.log('No match found for:', matchesName);
        }
      }
    }

    // Function to load matches for edit league
    async function loadMatchesForEditLeague() {
      const leagueId = document.getElementById('editLeague').value;
      const matchesDropdown = document.getElementById('editMatches');
      
      matchesDropdown.innerHTML = '<option value="">Select Match</option>';
      
      if (!leagueId) return;
      
      try {
        if (!validateAuth()) {
          return;
        }
        
        const response = await makeAuthenticatedRequest('https://web-anti-backend-8286388439.asia-southeast1.run.app/matches', {
          method: 'GET',
          headers: {
            'accept': 'application/json'
          }
        });
        
        if (response.ok) {
          const matches = await response.json();
          const leagueMatches = matches.filter(match => match.league_id === leagueId);
          
          const firstOption = '<option value="">Select Match</option>';
          const optionsHTML = leagueMatches.map(match => {
            const matchDate = new Date(match.match_date);
            const formattedDate = matchDate.toLocaleDateString('en-GB', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit'
            });
            
            return `<option value="${match.match_id}">${match.home_team} VS ${match.away_team} (${formattedDate})</option>`;
          }).join('');
          
          matchesDropdown.innerHTML = firstOption + optionsHTML;
          console.log('Matches loaded for edit league:', leagueMatches.length, 'matches');
          console.log('League matches data:', leagueMatches);
        }
      } catch (error) {
        console.error('Error loading matches for edit:', error);
      }
    }

    // Function to load edit images
    async function loadEditImages(submissionId) {
      try {
        if (!validateAuth()) {
          return;
        }
        
        const response = await makeAuthenticatedRequest(`https://web-anti-backend-8286388439.asia-southeast1.run.app/upload/list/${submissionId}`, {
          method: 'GET',
          headers: {
            'accept': 'application/json'
          }
        });
        
        if (response.ok) {
          const images = await response.json();
          displayEditImages(images);
        } else {
          displayEditNoImages();
        }
      } catch (error) {
        console.error('Error loading edit images:', error);
        displayEditNoImages();
      }
    }

    // Function to display edit images
    function displayEditImages(images) {
      const container = document.getElementById('editImagesContainer');
      
      if (!images || images.length === 0) {
        displayEditNoImages();
        return;
      }
      
      container.innerHTML = `
        <div class="row">
          ${images.map((image, index) => `
            <div class="col-md-4 mb-3">
              <div class="card">
                <div class="card-body p-2">
                  <img src="${image.file_url.startsWith('gs://') 
                    ? `https://storage.googleapis.com/${image.file_url.replace('gs://', '')}` 
                    : image.file_url}" 
                       class="img-fluid rounded" style="max-height: 120px; width: 100%; object-fit: cover;"
                       onerror="this.src='demo.webp'">
                  <div class="small text-muted mt-1">${image.file_name}</div>
                  <div class="small text-muted">${(image.file_size / 1024).toFixed(1)} KB</div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Function to display no edit images message
    function displayEditNoImages() {
      const container = document.getElementById('editImagesContainer');
      container.innerHTML = `
        <div class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
          <div class="text-muted">
            <i class="bi bi-image fs-1 d-block mb-2"></i>
            <span>No images attached</span>
          </div>
        </div>
      `;
    }

    // Function to add new images for edit
    function addEditImages(input) {
      if (input.files) {
        const files = Array.from(input.files);
        
        files.forEach(file => {
          const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
          if (!allowedTypes.includes(file.type)) {
            alert(`File ${file.name} is not a valid image type. Please select JPG, PNG, GIF, or WEBP files.`);
            return;
          }
          
          const maxSize = 5 * 1024 * 1024; // 5MB
          if (file.size > maxSize) {
            alert(`File ${file.name} is too large. Maximum size is 5MB.`);
            return;
          }
          
          selectedEditImages.push(file);
        });
        
        updateEditNewImagesPreview();
        input.value = '';
      }
    }

    // Function to update edit new images preview
    function updateEditNewImagesPreview() {
      const container = document.getElementById('editNewImagesContainer');
      
      if (selectedEditImages.length === 0) {
        container.innerHTML = '<div class="text-muted text-center py-3"><i class="bi bi-image fs-4 d-block mb-2"></i>No new images selected</div>';
        return;
      }
      
      const imagesHTML = selectedEditImages.map((file, index) => `
        <div class="col-md-4 mb-3">
          <div class="card">
            <div class="card-body p-2">
              <img src="${URL.createObjectURL(file)}" class="img-fluid rounded" style="max-height: 120px; width: 100%; object-fit: cover;">
              <div class="small text-muted mt-1">${file.name}</div>
              <div class="small text-muted">${(file.size / 1024).toFixed(1)} KB</div>
              <button type="button" class="btn btn-sm btn-outline-danger mt-1" onclick="removeEditImage(${index})">
                <i class="bi bi-trash"></i> Remove
              </button>
            </div>
          </div>
        </div>
      `).join('');
      
      container.innerHTML = `
        <div class="row">
          ${imagesHTML}
        </div>
      `;
    }

    // Function to remove edit image
    function removeEditImage(index) {
      selectedEditImages.splice(index, 1);
      updateEditNewImagesPreview();
    }

    // Function to clear all edit images
    function clearAllEditImages() {
      selectedEditImages = [];
      updateEditNewImagesPreview();
      document.getElementById('editNewImages').value = '';
    }

    // Function to load match details for edit
    async function loadMatchDetailsForEdit(matchId) {
      try {
        if (!validateAuth()) {
          return;
        }
        
        console.log('Loading match details for match ID:', matchId);
        
        // Fetch match details from API
        const response = await makeAuthenticatedRequest(`https://web-anti-backend-8286388439.asia-southeast1.run.app/matches/${matchId}`, {
          method: 'GET',
          headers: {
            'accept': 'application/json'
          }
        });
        
        if (response.ok) {
          const matchDetails = await response.json();
          console.log('Match details loaded:', matchDetails);
          
          // Load leagues first
          await loadLeaguesForEdit();
          
          // Set the league
          await setEditLeagueFromMatch(matchDetails.league_id);
          
          // Load matches for the league
          await loadMatchesForEditLeague();
          
          // Set the match
          setTimeout(() => {
            setEditMatchById(matchId);
          }, 200);
          
        } else {
          console.error('Error loading match details:', response.status);
          // Fallback to manual loading
          await loadLeaguesForEdit();
        }
      } catch (error) {
        console.error('Network error loading match details:', error);
        // Fallback to manual loading
        await loadLeaguesForEdit();
      }
    }

    // Function to set league from match details
    async function setEditLeagueFromMatch(leagueId) {
      const editLeagueDropdown = document.getElementById('editLeague');
      
      if (editLeagueDropdown && leagueId) {
        editLeagueDropdown.value = leagueId;
        console.log('League set to:', leagueId);
      }
    }

    // Function to set match by ID
    function setEditMatchById(matchId) {
      const editMatchesDropdown = document.getElementById('editMatches');
      
      if (editMatchesDropdown && matchId) {
        editMatchesDropdown.value = matchId;
        console.log('Match set to ID:', matchId);
      }
    }

    // Function to update stream details
    async function updateStreamDetails() {
      const form = document.getElementById('editStreamForm');
      const formData = new FormData(form);
      
      // Get form values
      const urlAddress = formData.get('editUrl');
      const urlType = formData.get('editType');
      const urlLeague = formData.get('editLeague');
      const urlMatches = formData.get('editMatches');
      const urlStatus = formData.get('editStatus');
      
      // Validate form
      if (!urlAddress || !urlType || !urlLeague || !urlMatches || !urlStatus) {
        alert('Please fill in all required fields');
        return;
      }
      
      // Validate URL format
      try {
        new URL(urlAddress);
      } catch (error) {
        alert('Please enter a valid URL');
        return;
      }
      
      // Get Update button for loading state
      const updateBtn = document.querySelector('#editStreamModal .btn.btn-primary');
      const originalBtnHTML = updateBtn.innerHTML;
      
      // Set loading state
      updateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Updating...';
      updateBtn.disabled = true;
      
      try {
        if (!validateAuth()) {
          return;
        }
        
        // Prepare payload for update
        const payload = {
          url: urlAddress,
          type: urlType,
          league_id: urlLeague,
          match_id: urlMatches,
          status: urlStatus
        };
        
        console.log('Updating URL submission:', payload);
        
        // Make PUT API call to update the submission
        const response = await makeAuthenticatedRequest(`https://web-anti-backend-8286388439.asia-southeast1.run.app/url_submission/${currentEditSubmissionId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'accept': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        
        if (response.ok) {
          console.log('URL submission updated successfully');
          
          // Upload new images if any
          if (selectedEditImages.length > 0) {
            console.log(`Uploading ${selectedEditImages.length} new images`);
            
            const token = getValidAccessToken();
            if (!token) {
              alert('Authentication token not found for image upload. Please login again.');
              return;
            }
            
            let uploadedCount = 0;
            let failedCount = 0;
            
            for (const imageFile of selectedEditImages) {
              try {
                const imageFormData = new FormData();
                imageFormData.append('file', imageFile);
                
                const imageResponse = await fetch(`https://web-anti-backend-8286388439.asia-southeast1.run.app/upload/${currentEditSubmissionId}`, {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${token}`,
                    'accept': 'application/json'
                  },
                  body: imageFormData
                });
                
                if (imageResponse.ok) {
                  console.log(`Image ${imageFile.name} uploaded successfully`);
                  uploadedCount++;
                } else {
                  console.error(`Error uploading image ${imageFile.name}`);
                  failedCount++;
                }
              } catch (imageError) {
                console.error(`Network error uploading image ${imageFile.name}:`, imageError);
                failedCount++;
              }
            }
            
            // Show result message
            if (uploadedCount > 0 && failedCount === 0) {
              alert(`URL submission updated and ${uploadedCount} new image(s) uploaded successfully!`);
            } else if (uploadedCount > 0 && failedCount > 0) {
              alert(`URL submission updated successfully! ${uploadedCount} new image(s) uploaded, ${failedCount} failed.`);
            } else if (uploadedCount === 0 && failedCount > 0) {
              alert('URL submission updated successfully, but all new image uploads failed.');
            }
          } else {
            alert('URL submission updated successfully!');
          }
          
          // Close modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('editStreamModal'));
          modal.hide();
          
          // Reset form
          form.reset();
          clearAllEditImages();
          
          // Reload URL submissions data
          loadUrlSubmissions();
          
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error('Error updating URL submission:', errorData);
          alert('Error updating URL submission: ' + (errorData.detail || 'Unknown error'));
        }
        
      } catch (error) {
        console.error('Network error updating URL submission:', error);
        alert('Network error. Please try again. Error: ' + error.message);
      } finally {
        // Restore button state
        updateBtn.innerHTML = originalBtnHTML;
        updateBtn.disabled = false;
      }
    }


  </script>
</body>
</html> 