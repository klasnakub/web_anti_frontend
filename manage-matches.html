<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Matches - Steam Guard Dashboard</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --dark-bg: #1a1a2e;
      --card-bg: rgba(255, 255, 255, 0.95);
      --sidebar-bg: rgba(26, 26, 46, 0.95);
    }
    
    body {
      background: var(--primary-gradient);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .sidebar {
      background: linear-gradient(rgba(26, 26, 46, 0.8), rgba(26, 26, 46, 0.8)), url('backgroud2.jpg');
      background-size: cover;
      background-position: center;
      backdrop-filter: blur(10px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .main-content {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      min-height: 100vh;
    }
    
    .card {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border: none;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .btn-modern {
      border-radius: 25px;
      padding: 10px 25px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-modern:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .nav-link {
      border-radius: 10px;
      margin: 5px 0;
      transition: all 0.3s ease;
    }
    
    .nav-link:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(5px);
    }
    
    .table {
      border-radius: 15px;
      overflow: hidden;
    }
    
    .table thead th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      font-weight: 600;
    }
    
    .search-box {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 25px;
      border: none;
      padding: 12px 20px;
    }
    
    .search-box:focus {
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
    }
    
    .badge {
      min-width: 80px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container-fluid p-0">
    <div class="row g-0">
      <!-- Modern Sidebar -->
      <div class="col-lg-2 col-md-3 sidebar d-none d-md-block" style="min-height: 100vh;">
        <div class="p-4 position-relative" style="min-height: 100vh;">
          <!-- Logo Section -->
          <div class="text-center mb-5">
            <div class="bg-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
              <i class="bi bi-display-fill text-primary fs-3"></i>
            </div>
            <h5 class="text-white fw-bold mb-0">Steam Guard</h5>
            <small class="text-white-50">Dashboard v0.1</small>
          </div>
          
          <!-- Navigation -->
          <nav class="nav flex-column">
            <a class="nav-link text-white-50 d-flex align-items-center" href="index.html">
              <i class="bi bi-speedometer2 me-3"></i>
              <span>Dashboard</span>
            </a>
            <a class="nav-link text-white-50 d-flex align-items-center" href="manage-leagues.html">
              <i class="bi bi-trophy me-3"></i>
              <span>Manage Leagues</span>
            </a>
            <a class="nav-link active text-white d-flex align-items-center" href="manage-matches.html">
              <i class="bi bi-calendar-event me-3"></i>
              <span>Manage Matches</span>
            </a>
          </nav>
          
          <hr class="text-white-50 my-4">
          
          <!-- User Section -->
          <div class="text-center position-absolute bottom-0 start-0 end-0 p-4">
            <div class="bg-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 40px; height: 40px;">
              <i class="bi bi-person-fill text-primary"></i>
            </div>
            <div class="text-white-50 small" id="userDisplay">Admin User</div>
            <a href="#" class="nav-link text-white-50 small logout">
              <i class="bi bi-box-arrow-right me-1"></i>Logout
            </a>
          </div>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="col-lg-10 col-md-9 main-content">
        <div class="p-4">
          <!-- Search and Filters -->
          <div class="card mb-4">
            <div class="card-body">
              <div class="row g-3 align-items-end">
                <div class="col-lg-3">
                  <label class="form-label fw-semibold">Search Matches</label>
                  <div class="input-group">
                    <span class="input-group-text bg-transparent border-0">
                      <i class="bi bi-search text-muted"></i>
                    </span>
                    <input type="text" class="form-control search-box" placeholder="Search by team names, league...">
                  </div>
                </div>
                <div class="col-lg-2">
                  <label class="form-label fw-semibold">League</label>
                  <select class="form-select">
                    <option selected>All Leagues</option>
                    <!-- Options will be loaded dynamically from table data -->
                  </select>
                </div>
                <div class="col-lg-2">
                  <label class="form-label fw-semibold">Status</label>
                  <select class="form-select">
                    <option selected>All Status</option>
                    <!-- Options will be loaded dynamically from table data -->
                  </select>
                </div>
                <div class="col-lg-2">
                  <label class="form-label fw-semibold">Date</label>
                  <select class="form-select">
                    <option selected>All Dates</option>
                    <!-- Options will be loaded dynamically from table data -->
                  </select>
                </div>
                <div class="col-lg-2">
                  <button class="btn btn-primary btn-modern w-100" onclick="applyFilters()">
                    <i class="bi bi-funnel me-2"></i>Filter
                  </button>
                </div>
                <div class="col-lg-1">
                  <button class="btn btn-outline-secondary btn-modern w-100" onclick="clearFilters()" title="Clear Filters">
                    <i class="bi bi-x-circle"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Matches Table -->
          <div class="card">
            <div class="card-header bg-transparent border-0">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0 fw-bold">
                  <i class="bi bi-calendar-event me-2"></i>Matches Management
                </h5>
                <div class="d-flex gap-2">
                  <button class="btn btn-light btn-modern" data-bs-toggle="modal" data-bs-target="#addMatchModal">
                    <i class="bi bi-plus-circle me-2"></i>Add Match
                  </button>
                  <button class="btn btn-light btn-modern text-dark" onclick="exportToCSV()">
                    <i class="bi bi-download me-2"></i>Export
                  </button>
                </div>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead>
                    <tr>
                      <th class="fw-semibold">Match ID</th>
                      <th class="fw-semibold">Home Team</th>
                      <th class="fw-semibold">Away Team</th>
                      <th class="fw-semibold">League Name</th>
                      <th class="fw-semibold">Date & Time</th>
                      <th class="fw-semibold">Status</th>
                      <th class="fw-semibold">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Data will be loaded from API -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Match Modal -->
  <div class="modal fade" id="addMatchModal" tabindex="-1" aria-labelledby="addMatchModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="addMatchModalLabel">
            <i class="bi bi-plus-circle me-2"></i>Add New Match
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addMatchForm">
            <div class="row g-3">
              <div class="col-12">
                <label for="matchId" class="form-label fw-semibold">Match ID</label>
                <input type="text" class="form-control" id="matchId" name="matchId" required>
              </div>
              <div class="col-md-6">
                <label for="homeTeam" class="form-label fw-semibold">Home Team</label>
                <input type="text" class="form-control" id="homeTeam" name="homeTeam" required>
              </div>
              <div class="col-md-6">
                <label for="awayTeam" class="form-label fw-semibold">Away Team</label>
                <input type="text" class="form-control" id="awayTeam" name="awayTeam" required>
              </div>
              <div class="col-md-6">
                <label for="leagueName" class="form-label fw-semibold">League Name</label>
                <select class="form-select" id="leagueName" name="leagueName" required>
                  <option value="">Select League</option>
                  <!-- Options will be loaded from API -->
                </select>
              </div>
              <div class="col-md-6">
                <label for="matchDate" class="form-label fw-semibold">Date & Time</label>
                <input type="datetime-local" class="form-control" id="matchDate" name="matchDate" required>
              </div>
              <div class="col-md-6">
                <label for="matchStatus" class="form-label fw-semibold">Status</label>
                <select class="form-select" id="matchStatus" name="matchStatus" required>
                  <option value="">Select Status</option>
                  <option value="Active">Active</option>
                  <option value="Inactive">Inactive</option>
                </select>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="addNewMatch()">
            <i class="bi bi-plus-circle me-2"></i>Add Match
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Auth Utility -->
  <script src="auth.js"></script>
  
  <script>
    // Global variable to store original data
    let originalMatches = [];
    
    // --- Auth check ---
    if (!validateAuth()) {
      // validateAuth() will handle the redirect
      // This prevents the rest of the script from executing
      throw new Error('Authentication failed');
    }

    // Logout handler
    const logoutBtn = document.querySelector('.logout');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', function(e) {
        e.preventDefault();
        logout();
      });
    }

    // Update user display and load data
    document.addEventListener('DOMContentLoaded', function() {
      displayTokenInfo();
      
      // Load matches and leagues when page loads
      loadMatches();
      loadLeaguesForDropdowns();
      
      // Add event listeners for modals
      const addMatchModal = document.getElementById('addMatchModal');
      if (addMatchModal) {
        addMatchModal.addEventListener('show.bs.modal', function() {
          // Reload leagues when opening Add Match modal
          loadLeaguesForDropdowns();
        });
      }
      
      const editMatchModal = document.getElementById('editMatchModal');
      if (editMatchModal) {
        editMatchModal.addEventListener('show.bs.modal', function() {
          // Reload leagues when opening Edit Match modal
          loadLeaguesForDropdowns();
        });
      }
    });
    function exportToCSV() {
      // Check authentication before proceeding
      if (!validateAuth()) {
        return;
      }
      
      try {
        // Get the table
        const table = document.querySelector('table');
        if (!table) {
          alert('Table not found');
          return;
        }

        // Get all rows from tbody
        const rows = table.querySelectorAll('tbody tr');
        if (rows.length === 0) {
          alert('No data to export');
          return;
        }

        // Define CSV headers
        const headers = ['Match ID', 'Home Team', 'Away Team', 'League Name', 'Date & Time', 'Status'];
        
        // Initialize CSV content with headers
        let csvContent = headers.join(',') + '\n';

        // Add data rows
        rows.forEach((row, index) => {
          const cells = row.querySelectorAll('td');
          if (cells.length >= 6) {
            const rowData = [];
            
            // Match ID column
            const matchIdCell = cells[0].textContent.trim();
            rowData.push(`"${matchIdCell}"`);
            
            // Home Team column
            const homeTeamCell = cells[1].textContent.trim();
            rowData.push(`"${homeTeamCell}"`);
            
            // Away Team column
            const awayTeamCell = cells[2].textContent.trim();
            rowData.push(`"${awayTeamCell}"`);
            
            // League Name column
            const leagueNameCell = cells[3].textContent.trim();
            rowData.push(`"${leagueNameCell}"`);
            
            // Date & Time column
            const dateTimeCell = cells[4].textContent.trim();
            rowData.push(`"${dateTimeCell}"`);
            
            // Status column
            const statusCell = cells[5].textContent.trim();
            rowData.push(`"${statusCell}"`);
            
            csvContent += rowData.join(',') + '\n';
          }
        });

        // Create and download CSV file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        
        // Create download link
        if (link.download !== undefined) {
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', `matches_export_${new Date().toISOString().slice(0, 10)}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }

        console.log('CSV export completed successfully');
        alert('Matches data exported successfully!');
        
      } catch (error) {
        console.error('Error exporting CSV:', error);
        alert('Error exporting data. Please try again.');
      }
    }

    // Function to load matches from API
    async function loadMatches() {
      try {
        // Check authentication before proceeding
        if (!validateAuth()) {
          return;
        }
        
        // Fetch matches from API using authenticated request
        const response = await makeAuthenticatedRequest('https://web-anti-backend-8286388439.asia-southeast1.run.app/matches', {
          method: 'GET',
          headers: {
            'accept': 'application/json'
          }
        });
        
        if (response.ok) {
          const matches = await response.json();
          console.log('Matches loaded:', matches);
          
          // Store original data for filtering
          originalMatches = matches;
          
          displayMatches(matches);
        } else {
          console.error('Error loading matches:', response.status);
          // Show fallback data if API fails
          displayMatches([]);
        }
      } catch (error) {
        console.error('Network error loading matches:', error);
        // Show fallback data if network error
        displayMatches([]);
      }
    }

    // Function to display matches in table
    function displayMatches(matches) {
      const tbody = document.querySelector('table tbody');
      if (!tbody) return;
      
      if (matches.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center text-muted py-4">
              <i class="bi bi-inbox fs-1 d-block mb-2"></i>
              No matches found
            </td>
          </tr>
        `;
        return;
      }
      
      // Sort matches by Match ID (ascending order)
      const sortedMatches = matches.sort((a, b) => {
        const idA = parseInt(a.match_id) || 0;
        const idB = parseInt(b.match_id) || 0;
        return idA - idB;
      });
      
      tbody.innerHTML = sortedMatches.map((match, index) => {
        // Format date for display
        const matchDate = new Date(match.match_date);
        const formattedDate = matchDate.toLocaleString('en-GB', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        }).replace(',', '');
        
        return `
          <tr>
            <td><span class="badge bg-light text-dark">${match.match_id || 'N/A'}</span></td>
            <td><span class="fw-semibold">${match.home_team || 'N/A'}</span></td>
            <td><span class="fw-semibold">${match.away_team || 'N/A'}</span></td>
            <td>${match.league_name || 'N/A'}</td>
            <td>${formattedDate}</td>
            <td><span class="badge ${match.status === 'Active' ? 'bg-success' : 'bg-danger'}">${match.status || 'N/A'}</span></td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#viewMatchModal" 
                        onclick="populateViewMatchModal('${(match.home_team || '').replace(/'/g, "\\'")}', '${(match.away_team || '').replace(/'/g, "\\'")}', '${(match.league_name || '').replace(/'/g, "\\'")}', '${formattedDate.replace(/'/g, "\\'")}', '${(match.status || '').replace(/'/g, "\\'")}')">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editMatchModal" 
                        onclick="populateEditMatchModal('${(match.home_team || '').replace(/'/g, "\\'")}', '${(match.away_team || '').replace(/'/g, "\\'")}', '${match.league_id || ''}', '${match.match_date || ''}', '${(match.status || '').replace(/'/g, "\\'")}', '${match.match_id || ''}')">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="deleteMatch('${match.match_id || ''}', '${(match.home_team || '').replace(/'/g, "\\'")} vs ${(match.away_team || '').replace(/'/g, "\\'")}')">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      // Update filter dropdowns with unique values from table data
      updateFilterDropdowns(sortedMatches);
    }

    // Function to delete match
    async function deleteMatch(matchId, matchName) {
      if (!matchId) {
        alert('Match ID not found');
        return;
      }
      
      // Confirm deletion
      if (!confirm(`Are you sure you want to delete "${matchName}"?`)) {
        return;
      }
      
      try {
        // Check authentication before proceeding
        if (!validateAuth()) {
          return;
        }
        
        // Make DELETE API call using authenticated request
        const response = await makeAuthenticatedRequest(`https://web-anti-backend-8286388439.asia-southeast1.run.app/matches/${matchId}`, {
          method: 'DELETE',
          headers: {
            'accept': 'application/json'
          }
        });
        
        if (response.ok) {
          console.log('Match deleted successfully');
          alert('Match deleted successfully!');
          
          // Reload matches data
          loadMatches();
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error('Error deleting match:', errorData);
          alert('Error deleting match: ' + (errorData.detail || 'Unknown error'));
        }
        
      } catch (error) {
        console.error('Network error deleting match:', error);
        alert('Network error. Please try again.');
      }
    }

    // Function to load leagues for dropdowns (return Promise)
    async function loadLeaguesForDropdowns() {
      return new Promise(async (resolve) => {
        try {
          // Check authentication before proceeding
          if (!validateAuth()) {
            resolve();
            return;
          }
          // Show loading state
          showLeagueDropdownsLoading();
          // Fetch leagues from API using authenticated request
          const response = await makeAuthenticatedRequest('https://web-anti-backend-8286388439.asia-southeast1.run.app/leagues', {
            method: 'GET',
            headers: {
              'accept': 'application/json'
            }
          });
          if (response.ok) {
            const leagues = await response.json();
            populateLeagueDropdowns(leagues);
          }
        } catch (error) {
          // error handling ตามเดิม
        } finally {
          resolve();
        }
      });
    }

    // Function to populate league dropdowns
    function populateLeagueDropdowns(leagues) {
      // Filter only active leagues
      const activeLeagues = leagues.filter(league => league.status === 'Active');
      
      // Get dropdown elements
      const addLeagueDropdown = document.getElementById('leagueName');
      const editLeagueDropdown = document.getElementById('editLeagueName');
      
      // Create options HTML (value = league_id, label = league_name (country))
      const optionsHTML = activeLeagues.map(league => 
        `<option value="${league.league_id}">${league.league_name} (${league.country})</option>`
      ).join('');
      
      // Populate Add Match dropdown
      if (addLeagueDropdown) {
        // Keep the first "Select League" option
        const firstOption = addLeagueDropdown.querySelector('option');
        addLeagueDropdown.innerHTML = firstOption.outerHTML + optionsHTML;
      }
      
      // Populate Edit Match dropdown
      if (editLeagueDropdown) {
        // Keep the first "Select League" option
        const firstOption = editLeagueDropdown.querySelector('option');
        editLeagueDropdown.innerHTML = firstOption.outerHTML + optionsHTML;
      }
      
      console.log('League dropdowns populated with', activeLeagues.length, 'active leagues');
    }

    // Function to show loading state in league dropdowns
    function showLeagueDropdownsLoading() {
      const addLeagueDropdown = document.getElementById('leagueName');
      const editLeagueDropdown = document.getElementById('editLeagueName');
      
      const loadingHTML = '<option value="">Select League...</option>';
      
      if (addLeagueDropdown) {
        addLeagueDropdown.innerHTML = loadingHTML;
      }
      
      if (editLeagueDropdown) {
        editLeagueDropdown.innerHTML = loadingHTML;
      }
    }

    // Function to load league details for edit
    async function loadLeagueDetailsForEdit(leagueId) {
      try {
        if (!validateAuth()) {
          return;
        }
        
        console.log('Loading league details for league ID:', leagueId);
        
        // Fetch league details from API
        const response = await makeAuthenticatedRequest(`https://web-anti-backend-8286388439.asia-southeast1.run.app/leagues/${leagueId}`, {
          method: 'GET',
          headers: {
            'accept': 'application/json'
          }
        });
        
        if (response.ok) {
          const leagueDetails = await response.json();
          console.log('League details loaded:', leagueDetails);
          
          // Load all leagues first
          await loadLeaguesForDropdowns();
          
          // Set the specific league
          setTimeout(() => {
            setEditLeagueById(leagueId);
          }, 200);
          
        } else {
          console.error('Error loading league details:', response.status);
          // Fallback to loading all leagues
          await loadLeaguesForDropdowns();
        }
      } catch (error) {
        console.error('Network error loading league details:', error);
        // Fallback to loading all leagues
        await loadLeaguesForDropdowns();
      }
    }

    // Function to set league by ID in edit modal
    function setEditLeagueById(leagueId) {
      const editLeagueDropdown = document.getElementById('editLeagueName');
      
      if (editLeagueDropdown && leagueId) {
        editLeagueDropdown.value = leagueId;
        console.log('League set to ID:', leagueId);
      }
    }

    async function addNewMatch() {
      const form = document.getElementById('addMatchForm');
      const formData = new FormData(form);
      // Get Add Match button
      const addBtn = document.querySelector('#addMatchModal .btn.btn-primary');
      const originalBtnHTML = addBtn.innerHTML;
      // Set loading state
      addBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Adding...';
      addBtn.disabled = true;
      
      // Get form values
      const matchId = formData.get('matchId');
      const homeTeam = formData.get('homeTeam');
      const awayTeam = formData.get('awayTeam');
      const leagueId = formData.get('leagueName'); // now leagueId
      const matchDate = formData.get('matchDate');
      const matchStatus = formData.get('matchStatus');
      
      // Validate form
      if (!matchId || !homeTeam || !awayTeam || !leagueId || !matchDate || !matchStatus) {
        alert('Please fill in all fields');
        // Restore button
        addBtn.innerHTML = originalBtnHTML;
        addBtn.disabled = false;
        return;
      }
      
      try {
        // Check authentication before proceeding
        if (!validateAuth()) {
          // Restore button
          addBtn.innerHTML = originalBtnHTML;
          addBtn.disabled = false;
          return;
        }
        // 1. โหลด leagues เพื่อหา league_name
        const leaguesResp = await makeAuthenticatedRequest('https://web-anti-backend-8286388439.asia-southeast1.run.app/leagues', {
          method: 'GET',
          headers: { 'accept': 'application/json' }
        });
        const leagues = await leaguesResp.json();
        const league = leagues.find(l => l.league_id === leagueId);
        const leagueName = league ? league.league_name : '';

        // 2. Prepare payload for API using user-input Match ID
        const payload = {
          match_id: matchId,
          home_team: homeTeam,
          away_team: awayTeam,
          league_id: leagueId, // use league_id
          league_name: leagueName,
          match_date: new Date(matchDate).toISOString(),
          status: matchStatus
        };
        
        console.log('Sending match data:', payload);
        
        // Make POST API call using authenticated request
        const response = await makeAuthenticatedRequest('https://web-anti-backend-8286388439.asia-southeast1.run.app/matches', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'accept': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('Match added successfully:', result);
          
          // Show success message
          alert('Match added successfully!');
          
          // Reset form and close modal
          form.reset();
          const modal = bootstrap.Modal.getInstance(document.getElementById('addMatchModal'));
          modal.hide();
          
          // Reload matches data
          loadMatches();
          
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error('Error adding match:', errorData);
          alert('Error adding match: ' + (errorData.detail || 'Unknown error'));
        }
        
      } catch (error) {
        console.error('Network error adding match:', error);
        alert('Network error. Please try again.');
      } finally {
        // Restore button
        addBtn.innerHTML = originalBtnHTML;
        addBtn.disabled = false;
      }
    }
  </script>

  <!-- Edit Match Modal -->
  <div class="modal fade" id="editMatchModal" tabindex="-1" aria-labelledby="editMatchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="editMatchModalLabel">
            <i class="bi bi-pencil me-2"></i>Edit Match
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editMatchForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="editHomeTeam" class="form-label fw-semibold">Home Team</label>
                <input type="text" class="form-control" id="editHomeTeam" name="editHomeTeam" required>
              </div>
              <div class="col-md-6">
                <label for="editAwayTeam" class="form-label fw-semibold">Away Team</label>
                <input type="text" class="form-control" id="editAwayTeam" name="editAwayTeam" required>
              </div>
              <div class="col-md-6">
                <label for="editLeagueName" class="form-label fw-semibold">League Name</label>
                <select class="form-select" id="editLeagueName" name="editLeagueName" required>
                  <option value="">Select League</option>
                  <!-- Options will be loaded from API -->
                </select>
              </div>
              <div class="col-md-6">
                <label for="editMatchDate" class="form-label fw-semibold">Date & Time</label>
                <input type="datetime-local" class="form-control" id="editMatchDate" name="editMatchDate" required>
              </div>
              <div class="col-md-6">
                <label for="editMatchStatus" class="form-label fw-semibold">Status</label>
                <select class="form-select" id="editMatchStatus" name="editMatchStatus" required>
                  <option value="">Select Status</option>
                  <option value="Active">Active</option>
                  <option value="Inactive">Inactive</option>
                </select>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="updateMatch()">
            <i class="bi bi-check-circle me-2"></i>Update Match
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- View Match Modal -->
  <div class="modal fade" id="viewMatchModal" tabindex="-1" aria-labelledby="viewMatchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="viewMatchModalLabel">
            <i class="bi bi-eye me-2"></i>Match Details
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-12">
              <div class="mb-3">
                <label class="form-label fw-bold">Home Team</label>
                <p class="form-control-plaintext" id="viewHomeTeam">-</p>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">Away Team</label>
                <p class="form-control-plaintext" id="viewAwayTeam">-</p>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">League Name</label>
                <p class="form-control-plaintext" id="viewLeagueName">-</p>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">Date & Time</label>
                <p class="form-control-plaintext" id="viewMatchDate">-</p>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">Status</label>
                <span class="badge" id="viewMatchStatus">-</span>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-2"></i>Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function populateEditMatchModal(homeTeam, awayTeam, leagueId, matchDate, matchStatus, matchId) {
      console.log('Edit Match Modal Data:', { homeTeam, awayTeam, leagueId, matchDate, matchStatus, matchId });
      
      try {
        // Store match ID in modal for update operation
        document.getElementById('editMatchModal').setAttribute('data-match-id', matchId);
        
        // Update modal title
        const modalLabel = document.getElementById('editMatchModalLabel');
        if (modalLabel) {
          modalLabel.innerHTML = '<i class="bi bi-pencil me-2"></i>Edit Match - ' + homeTeam + ' vs ' + awayTeam;
        }
        
        // Populate form fields with current data
        document.getElementById('editHomeTeam').value = homeTeam || '';
        document.getElementById('editAwayTeam').value = awayTeam || '';
        
        // Load league details from API if we have leagueId
        if (leagueId) {
          await loadLeagueDetailsForEdit(leagueId);
        } else {
          // Fallback: load all leagues
          await loadLeaguesForDropdowns();
        }
        
        // Convert date string to datetime-local format
        if (matchDate) {
          const dateObj = new Date(matchDate);
          const year = dateObj.getFullYear();
          const month = String(dateObj.getMonth() + 1).padStart(2, '0');
          const day = String(dateObj.getDate()).padStart(2, '0');
          const hours = String(dateObj.getHours()).padStart(2, '0');
          const minutes = String(dateObj.getMinutes()).padStart(2, '0');
          const datetimeLocal = `${year}-${month}-${day}T${hours}:${minutes}`;
          document.getElementById('editMatchDate').value = datetimeLocal;
        }
        
        document.getElementById('editMatchStatus').value = matchStatus || '';
        
        console.log('Edit match modal populated successfully');
      } catch (error) {
        console.error('Error populating edit match modal:', error);
        alert('Error loading match data for editing. Please try again.');
      }
    }

    async function updateMatch() {
      const form = document.getElementById('editMatchForm');
      const formData = new FormData(form);
      // Get Update Match button
      const updateBtn = document.querySelector('#editMatchModal .btn.btn-primary');
      const originalBtnHTML = updateBtn.innerHTML;
      // Set loading state
      updateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Updating...';
      updateBtn.disabled = true;
      
      // Get form values
      const homeTeam = formData.get('editHomeTeam');
      const awayTeam = formData.get('editAwayTeam');
      const leagueId = formData.get('editLeagueName'); // now leagueId
      const matchDate = formData.get('editMatchDate');
      const matchStatus = formData.get('editMatchStatus');
      
      // Validate form
      if (!homeTeam || !awayTeam || !leagueId || !matchDate || !matchStatus) {
        alert('Please fill in all fields');
        // Restore button
        updateBtn.innerHTML = originalBtnHTML;
        updateBtn.disabled = false;
        return;
      }
      
      // Get match ID from modal
      const matchId = document.getElementById('editMatchModal').getAttribute('data-match-id');
      
      if (!matchId) {
        alert('Match ID not found');
        // Restore button
        updateBtn.innerHTML = originalBtnHTML;
        updateBtn.disabled = false;
        return;
      }
      
      try {
        // Check authentication before proceeding
        if (!validateAuth()) {
          // Restore button
          updateBtn.innerHTML = originalBtnHTML;
          updateBtn.disabled = false;
          return;
        }
        // 1. โหลด leagues เพื่อหา league_name
        const leaguesResp = await makeAuthenticatedRequest('https://web-anti-backend-8286388439.asia-southeast1.run.app/leagues', {
          method: 'GET',
          headers: { 'accept': 'application/json' }
        });
        const leagues = await leaguesResp.json();
        const league = leagues.find(l => l.league_id === leagueId);
        const leagueName = league ? league.league_name : '';
        // 2. Prepare payload for API
        const payload = {
          match_id: matchId,
          home_team: homeTeam,
          away_team: awayTeam,
          league_id: leagueId, // use league_id
          league_name: leagueName,
          match_date: new Date(matchDate).toISOString(),
          status: matchStatus
        };
        
        console.log('Sending update payload:', payload);
        
        // Make PUT API call using authenticated request
        const response = await makeAuthenticatedRequest(`https://web-anti-backend-8286388439.asia-southeast1.run.app/matches/${matchId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'accept': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('Match updated successfully:', result);
          
          // Show success message
          alert('Match updated successfully!');
          
          // Close modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('editMatchModal'));
          modal.hide();
          
          // Reload matches data
          loadMatches();
          
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error('Error updating match:', errorData);
          alert('Error updating match: ' + (errorData.detail || 'Unknown error'));
        }
        
      } catch (error) {
        console.error('Network error updating match:', error);
        alert('Network error. Please try again.');
      } finally {
        // Restore button
        updateBtn.innerHTML = originalBtnHTML;
        updateBtn.disabled = false;
      }
    }

    function populateViewMatchModal(homeTeam, awayTeam, leagueName, matchDate, matchStatus) {
      console.log('View Match Modal Data:', { homeTeam, awayTeam, leagueName, matchDate, matchStatus });
      
      try {
        // Update modal title
        const modalLabel = document.getElementById('viewMatchModalLabel');
        if (modalLabel) {
          modalLabel.innerHTML = '<i class="bi bi-eye me-2"></i>Match Details - ' + homeTeam + ' vs ' + awayTeam;
        }
        
        // Update form fields
        document.getElementById('viewHomeTeam').textContent = homeTeam || 'N/A';
        document.getElementById('viewAwayTeam').textContent = awayTeam || 'N/A';
        document.getElementById('viewLeagueName').textContent = leagueName || 'N/A';
        document.getElementById('viewMatchDate').textContent = matchDate || 'N/A';
        
        // Update status badge
        const statusBadge = document.getElementById('viewMatchStatus');
        if (statusBadge) {
          statusBadge.textContent = matchStatus || 'N/A';
          statusBadge.className = matchStatus === 'Active' ? 'badge bg-success' : 'badge bg-danger';
        }
        
        console.log('View match modal populated successfully');
      } catch (error) {
        console.error('Error populating view match modal:', error);
        alert('Error displaying match details. Please try again.');
      }
    }

    // Function to update filter dropdowns with unique values from table data
    function updateFilterDropdowns(matches) {
      // Get unique leagues from matches
      const uniqueLeagues = [...new Set(matches.map(match => match.league_name).filter(name => name && name !== 'N/A'))];
      
      // Get unique statuses from matches
      const uniqueStatuses = [...new Set(matches.map(match => match.status).filter(status => status && status !== 'N/A'))];
      
      // Get unique dates from matches
      const uniqueDates = [...new Set(matches.map(match => {
        const matchDate = new Date(match.match_date);
        return matchDate.toLocaleDateString('en-GB', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
      }).filter(date => date && date !== 'N/A'))];
      
      // Update League filter dropdown
      const leagueFilterDropdown = document.querySelector('.card-body .col-lg-2:nth-child(2) select');
      if (leagueFilterDropdown) {
        const firstOption = '<option selected>All Leagues</option>';
        const optionsHTML = uniqueLeagues.sort().map(league => 
          `<option value="${league}">${league}</option>`
        ).join('');
        leagueFilterDropdown.innerHTML = firstOption + optionsHTML;
        console.log('League filter dropdown updated with', uniqueLeagues.length, 'unique leagues');
      }
      
      // Update Status filter dropdown
      const statusFilterDropdown = document.querySelector('.card-body .col-lg-2:nth-child(3) select');
      if (statusFilterDropdown) {
        const firstOption = '<option selected>All Status</option>';
        const optionsHTML = uniqueStatuses.sort().map(status => 
          `<option value="${status}">${status}</option>`
        ).join('');
        statusFilterDropdown.innerHTML = firstOption + optionsHTML;
        console.log('Status filter dropdown updated with', uniqueStatuses.length, 'unique statuses');
      }
      
      // Update Date filter dropdown
      const dateFilterDropdown = document.querySelector('.card-body .col-lg-2:nth-child(4) select');
      if (dateFilterDropdown) {
        const firstOption = '<option selected>All Dates</option>';
        const optionsHTML = uniqueDates.sort().map(date => 
          `<option value="${date}">${date}</option>`
        ).join('');
        dateFilterDropdown.innerHTML = firstOption + optionsHTML;
        console.log('Date filter dropdown updated with', uniqueDates.length, 'unique dates');
      }
    }

    // Function to apply filters
    function applyFilters() {
      // Get filter values
      const searchText = document.querySelector('.search-box').value.toLowerCase().trim();
      const selectedLeague = document.querySelector('.card-body .col-lg-2:nth-child(2) select').value;
      const selectedStatus = document.querySelector('.card-body .col-lg-2:nth-child(3) select').value;
      const selectedDate = document.querySelector('.card-body .col-lg-2:nth-child(4) select').value;
      
      console.log('Applying filters:', {
        searchText,
        selectedLeague,
        selectedStatus,
        selectedDate
      });
      
      // Filter matches based on criteria
      const filteredMatches = originalMatches.filter(match => {
        // Search text filter (partial match)
        const searchMatch = !searchText || 
          (match.home_team && match.home_team.toLowerCase().includes(searchText)) ||
          (match.away_team && match.away_team.toLowerCase().includes(searchText)) ||
          (match.league_name && match.league_name.toLowerCase().includes(searchText));
        
        // League filter
        const leagueFilter = selectedLeague === 'All Leagues' || 
          (match.league_name && match.league_name === selectedLeague);
        
        // Status filter
        const statusFilter = selectedStatus === 'All Status' || 
          (match.status && match.status === selectedStatus);
        
        // Date filter
        const matchDate = new Date(match.match_date);
        const formattedMatchDate = matchDate.toLocaleDateString('en-GB', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
        const dateFilter = selectedDate === 'All Dates' || 
          formattedMatchDate === selectedDate;
        
        return searchMatch && leagueFilter && statusFilter && dateFilter;
      });
      
      console.log('Filtered results:', filteredMatches.length, 'out of', originalMatches.length);
      
      // Display filtered results
      displayMatches(filteredMatches);
    }

    // Function to clear all filters
    function clearFilters() {
      // Clear search box
      document.querySelector('.search-box').value = '';
      
      // Reset dropdowns to "All" options
      document.querySelector('.card-body .col-lg-2:nth-child(2) select').selectedIndex = 0;
      document.querySelector('.card-body .col-lg-2:nth-child(3) select').selectedIndex = 0;
      document.querySelector('.card-body .col-lg-2:nth-child(4) select').selectedIndex = 0;
      
      console.log('Filters cleared, showing all data');
      
      // Display original data
      displayMatches(originalMatches);
    }
  </script>
</body>
</html> 